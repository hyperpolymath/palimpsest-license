name: Docs

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '*.adoc'
      - 'legal/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'docs/**'
      - '*.adoc'
      - 'legal/**'

permissions:
  contents: read

jobs:
  build-docs:
    name: Build AsciiDoc docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Install Asciidoctor
        run: |
          sudo apt-get update
          sudo apt-get install -y asciidoctor

      - name: Build key docs
        run: |
          mkdir -p build/docs
          find . -name '*.adoc' -print0 | xargs -0 -n1 asciidoctor -D build/docs

  link-check:
    name: Check external links (best-effort)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Install lychee
        run: |
          curl -sSfL https://github.com/lycheeverse/lychee/releases/latest/download/lychee-linux-x86_64.tar.gz \
            | tar xz
          sudo mv lychee /usr/local/bin

      - name: Run link checker
        run: |
          lychee --no-progress --max-redirects 5 --retry-wait-time 2 --timeout 10 \
            README.adoc docs || true
